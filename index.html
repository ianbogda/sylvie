<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Hommage ‚Äî Sylvie Chevillard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="shortcut icon" href="/favicon.ico">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-config" content="/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">

  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Palette apaisement / recueillement */
      --ink: rgba(60, 66, 72, 1);
      --muted: rgba(120, 128, 136, 1);
      --stroke: rgba(50, 56, 62, .10);
      --card: rgba(255,255,255,.84);
      --shadow: 0 14px 46px rgba(18, 22, 26, .07);
      --r: 22px;

      --lilac: rgba(201, 193, 217, .22);
      --blush: rgba(232, 214, 220, .18);
      --mint:  rgba(203, 223, 216, .18);
    }

    /* Base */
    body{
      font-family: "Cormorant Garamond", serif;
      letter-spacing: .2px;
      color: var(--ink);
      background:
        radial-gradient(1000px 560px at 18% 6%, var(--lilac), transparent 64%),
        radial-gradient(1000px 560px at 82% 8%, var(--blush), transparent 64%),
        radial-gradient(1100px 620px at 50% 108%, var(--mint), transparent 64%),
        linear-gradient(180deg, #fbfaf7 0%, #f6f4f0 55%, #fbfaf7 100%);
      min-height: 100vh;
    }

    body::after{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.045;
      mix-blend-mode:multiply;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.4'/%3E%3C/svg%3E");
    }

    /* Glass surfaces */
    .glass{
      background: var(--card);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      border-radius: var(--r);
      backdrop-filter: blur(9px);
    }

    /* Header pill */
    .brandPill{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.78);
      border-radius: 999px;
      padding: 8px 12px;
      display:inline-flex;
      align-items:center;
      gap:10px;
    }

    .dot{
      width:10px;
      height:10px;
      border-radius:999px;
      background: linear-gradient(135deg, var(--lilac), var(--blush));
      box-shadow: 0 0 0 4px rgba(201,193,217,.18);
    }

    /* Hero */
    .hero{position:relative; overflow:hidden;}
    .heroInner{position:relative; padding: 34px 28px;}

    .avatarWrap{
      width: 152px;
      height: 152px;
      border-radius: 28px;
      padding: 10px;
      background: linear-gradient(135deg, var(--lilac), var(--blush), var(--mint));
      border: 1px solid var(--stroke);
      box-shadow: 0 12px 40px rgba(18,22,26,.10);
    }

    .avatar{
      width: 100%;
      height: 100%;
      border-radius: 22px;
      object-fit: cover;
      border: 1px solid var(--stroke);
      background: #f1f0ec;
    }

    /* Typography */
    .title{
      font-family: Fraunces, serif;
      letter-spacing: -0.03em;
      line-height: 1.05;
      font-weight: 600;
    }

    .subtitle{
      color: var(--muted);
    }

    /* Tags */
    .tag{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.82);
      border-radius: 999px;
      padding: 6px 12px;
      font-weight: 600;
    }

    /* Divider */
    .divider{
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--stroke), transparent);
      margin: 18px 0;
    }

    /* Buttons */
    .btn-soft{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.82);
      border-radius: 999px;
      font-weight: 600;
      transition: all .45s ease;
    }

    .btn-soft:hover{
      background: rgba(255,255,255,.94);
      transform: translateY(-1px);
    }

    .btn-candle{
      border: 1px solid rgba(201,193,217,.55);
      background: rgba(201,193,217,.20);
      border-radius: 16px;
      font-weight: 700;
      padding: 12px 14px;
      transition: all .55s ease;
    }

    .btn-candle:hover{
      background: rgba(201,193,217,.28);
    }

    /* Metrics */
    .metric{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.78);
    }

    /* Messages */
    .msg{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.82);
      border-radius: 16px;
      padding: 12px 14px;
    }

    .smallMuted{
      color: var(--muted);
    }

    /* Gallery */
    .gallery img{
      border-radius: 16px;
      border: 1px solid var(--stroke);
      transition: transform .55s ease, box-shadow .55s ease;
      background: #f1f0ec;
    }

    .gallery img:hover{
      transform: scale(1.012);
      box-shadow: 0 16px 36px rgba(18,22,26,.10);
    }

    .metricRow{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:14px;
    }

    .metricLabel{
      font-weight: 650;
      letter-spacing: .2px;
    }

    .metricValue{
      margin-left:auto;
      font-weight: 800;
      font-size: clamp(1.8rem, 2.4vw, 2.6rem);
      line-height: 1;
      text-align:right;
      font-variant-numeric: tabular-nums;
    }
    .metricSub{
      margin-top: 10px;
    }

    .candleStrip{
      display:flex;
      align-items:flex-end;
      gap:8px;
      flex-wrap:wrap;
    }

    .candle{
      width: 10px;
      height: 18px;
      border-radius: 6px;
      border: 1px solid rgba(50,56,62,.12);
      background: rgba(255,255,255,.78);
      position: relative;
      box-shadow: 0 6px 16px rgba(18,22,26,.06);
    }

    /* flamme */
    .candle::before{
      content:"";
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      top:-10px;
      width: 8px;
      height: 10px;
      border-radius: 8px 8px 8px 8px;
      background: radial-gradient(circle at 40% 35%,
        rgba(255,255,255,.9) 0%,
        rgba(255,223,170,.85) 35%,
        rgba(242,178,104,.55) 70%,
        rgba(242,178,104,0) 100%);
      filter: blur(.2px);
      opacity: .9;
      animation: flame 2.8s ease-in-out infinite;
    }

    /* petite m√®che */
    .candle::after{
      content:"";
      position:absolute;
      left:50%;
      top:-2px;
      transform: translateX(-50%);
      width: 2px;
      height: 4px;
      border-radius:2px;
      background: rgba(60,66,72,.35);
    }

    @keyframes flame{
      0%   { transform: translateX(-50%) scale(1); opacity:.85; }
      50%  { transform: translateX(-50%) scale(1.06); opacity:.95; }
      100% { transform: translateX(-50%) scale(1); opacity:.88; }
    }

    /* Respect du recueillement : si l'utilisateur r√©duit les animations */
    @media (prefers-reduced-motion: reduce){
      .candle::before{ animation:none; }
    }

    /* +X */
    .candleMore{
      font-size:.95rem;
      color: var(--muted);
      padding-left:6px;
    }

    /* Print */
    @media print{
      body{background:#fff}
      .no-print{display:none !important}
      .glass{box-shadow:none; backdrop-filter:none}
    }
  </style>
</head>

<body>
  <div class="container py-4 py-lg-5">

    <div class="d-flex justify-content-between align-items-center gap-2 mb-3 no-print">
      <div class="brandPill">
        <span class="dot" aria-hidden="true"></span>
        <strong>Espace hommage</strong>
        <span class="smallMuted">‚Äî Sylvie</span>
      </div>

      <div class="d-flex gap-2 flex-wrap">
        <button class="btn btn-sm btn-soft px-3" id="shareBtn" type="button">Partager</button>
        <button class="btn btn-sm btn-soft px-3" id="printBtn" type="button">Imprimer</button>
        <a class="btn btn-sm btn-soft px-3" href="#messages">Laisser un message</a>
      </div>
    </div>

    <section class="glass hero">
      <div class="heroInner">
        <div class="row align-items-center g-4">
          <div class="col-md-auto text-center text-md-start">
            <div class="avatarWrap mx-auto mx-md-0">
              <img class="avatar"
                   id="portraitImg"
                   src="./assets/sylvie.jpg"
                   alt="Portrait">
            </div>
          </div>

          <div class="col">
            <h1 class="title">Sylvie Chevillard</h1>

            <div class="d-flex flex-wrap gap-2 mt-3">
              <span class="tag">üïäÔ∏è 1955 ‚Äî 2026</span>
              <span class="tag">¬´ Tous capables ! ¬ª</span>
            </div>

            <p class="subtitle">
                ¬´ Souvenez-vous de ceux qui vous ont guid√©s ; consid√©rez leur vie, et imitez leur foi. ¬ª
            </p>

            <div class="divider"></div>

            <div class="row g-3 align-items-stretch">
              <div class="col-6 col-lg-3">
                <div class="metric glass">
                  <div class="metricRow">
                    <div class="metricLabel">Bougies</div>
                    <div class="metricValue" id="candlesCount">14</div>
                  </div>
                  <div class="metricSub" id="candlesViz"></div>
                </div>
              </div>
              <div class="col-6 col-lg-3">
                <div class="metric glass">
                  <div class="metricRow">
                    <div class="metricLabel">Messages</div>
                    <div class="metricValue" id="messagesCount">2</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-lg-6">
                <button class="w-100 btn btn-candle h-100" id="candleBtn" type="button">
                  üïØÔ∏è Allumer une bougie
                </button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <div class="status mt-3" id="statusBox" role="status" aria-live="polite"></div>

    <div class="row g-4 mt-1">
      <div class="col-lg-7">

        <section class="glass p-4">
          <div class="d-flex align-items-start gap-3">
            <div class="poemMark" aria-hidden="true">‚ù¶</div>
            <div>
              <h2 class="h5 mb-2" style="font-weight:900; letter-spacing:-.01em;">Tous capables !</h2>
              <p class="poem">
                ¬´ Souvenez-vous de ceux qui vous ont guid√©s ;
                consid√©rez leur vie, et imitez leur foi. ¬ª
              </p>
              <div class="smallMuted mt-2">
                (Modifiable) ‚Äî 2 √† 4 phrases maximum.
              </div>
            </div>
          </div>
        </section>

        <section class="glass p-4 mt-4">
          <h2 class="h5 mb-2" style="font-weight:900; letter-spacing:-.01em;">Biographie</h2>
          <p class="mb-2">
Sylvie est n√©e et a grandi √† Nogent-sur-Marne, dans un environnement modeste et √† une √©poque o√π les trajectoires semblaient souvent trac√©es d‚Äôavance.
Tr√®s t√¥t, elle a refus√© les chemins impos√©s, port√©e par une volont√© discr√®te mais d√©termin√©e.
Elle s‚Äôest accroch√©e, a travaill√©, et a d√©pass√© ce que son contexte social laissait pr√©sager en obtenant son baccalaur√©at puis en int√©grant l‚Äô√âcole normale.
          </p>
          <p class="mb-2">
Devenue institutrice, elle a exerc√© son m√©tier avec une conviction profonde : croire dans les capacit√©s de chacun.
¬´ Tous capables ¬ª n‚Äô√©tait pas pour elle une simple formule, mais une v√©ritable philosophie de vie.
Cette confiance dans les autres, elle l‚Äôa incarn√©e aussi bien dans sa classe que dans sa famille, avec exigence, bienveillance et une foi constante dans le potentiel humain.
          </p>
          <p class="mb-2">
Il y a plus de quarante ans, elle a choisi de s‚Äôinstaller √† Saint-Jean-de-la-Ruelle.
Ce lieu est devenu le th√©√¢tre d‚Äôune grande partie de sa vie.
Fid√®le √† son temp√©rament engag√©, elle s‚Äôest investie pleinement dans la vie locale, associative et citoyenne, convaincue que les liens et la participation donnent du sens √† l‚Äôexistence.
          </p>
          <p class="mb-2">
M√®re attentive, femme de convictions et de c≈ìur, elle a transmis autour d‚Äôelle une √©nergie, des valeurs et une mani√®re d‚Äô√™tre au monde.
Elle laisse le souvenir d‚Äôune pr√©sence chaleureuse, d‚Äôun esprit libre et d‚Äôune confiance ind√©fectible dans les autres, qui continueront longtemps de r√©sonner en ceux qui l‚Äôont connue et aim√©e.
          </p>
        </section>
      </div>

      <div class="col-lg-5">
        <section class="glass p-4">
          <h2 class="h5 mb-3" style="font-weight:900; letter-spacing:-.01em;">Rep√®res</h2>
          <div class="d-grid gap-2">
            <div class="p-3 rounded-4" style="border:1px solid rgba(15,23,42,.10); background:rgba(255,255,255,.70);">
              <div class="small fw-bold" style="letter-spacing:.06em; color:rgba(100,116,139,.95);">1955</div>
              <div>Naissance √† Nogent-Sur-Marne</div>
            </div>
            <div class="p-3 rounded-4" style="border:1px solid rgba(15,23,42,.10); background:rgba(255,255,255,.70);">
              <div class="small fw-bold" style="letter-spacing:.06em; color:rgba(100,116,139,.95);">1973</div>
              <div>Un souvenir marquant : ‚Ä¶</div>
            </div>
            <div class="p-3 rounded-4" style="border:1px solid rgba(15,23,42,.10); background:rgba(255,255,255,.70);">
              <div class="small fw-bold" style="letter-spacing:.06em; color:rgba(100,116,139,.95);">2026</div>
              <div>D√©c√®s ‚Äî entour√©e des siens</div>
            </div>
          </div>
        </section>
      </div>

      <div class="col-lg-7">
        <section class="glass p-4 mt-4">
          <div class="d-flex justify-content-between align-items-baseline gap-2 flex-wrap">
            <div>
              <h2 class="h5 mb-1" style="font-weight:900; letter-spacing:-.01em;">Galerie</h2>
            </div>
            <div class="no-print">
              <label class="btn btn-soft btn-sm px-3">
                Ajouter une photo
                <input id="uploadInput" type="file" accept="image/*" hidden>
              </label>
            </div>
          </div>

          <div class="row g-3 mt-2 gallery" id="gallery">
            <div class="col-sm-4">
              <img data-cap="Souvenir"
                   data-full="https://images.unsplash.com/photo-1482192596544-9eb780fc7f66?auto=format&fit=crop&w=2400&q=80"
                   src="https://images.unsplash.com/photo-1482192596544-9eb780fc7f66?auto=format&fit=crop&w=1200&q=80"
                   alt="Souvenir 1">
            </div>
            <div class="col-sm-4">
              <img data-cap="Souvenir"
                   data-full="https://images.unsplash.com/photo-1520975661595-6453be3f7070?auto=format&fit=crop&w=2400&q=80"
                   src="https://images.unsplash.com/photo-1520975661595-6453be3f7070?auto=format&fit=crop&w=1200&q=80"
                   alt="Souvenir 2">
            </div>
            <div class="col-sm-4">
              <img data-cap="Souvenir"
                   data-full="https://images.unsplash.com/photo-1452570053594-1b985d6ea890?auto=format&fit=crop&w=2400&q=80"
                   src="https://images.unsplash.com/photo-1452570053594-1b985d6ea890?auto=format&fit=crop&w=1200&q=80"
                   alt="Souvenir 3">
            </div>
          </div>
          <div class="mt-3 d-flex gap-2 align-items-center no-print">
            <button class="btn btn-soft btn-sm px-3" id="loadMoreBtn" type="button">Charger plus</button>
            <span class="smallMuted" id="galleryMeta"></span>
          </div>

          <div class="smallMuted mt-3">
            Astuce : privil√©gie des images ~1600px de large, lumi√®re naturelle, contraste doux.
          </div>
        </section>
      </div>

      <div class="col-lg-5">
        <section class="glass p-4 mt-4" id="messages">
          <div class="d-flex justify-content-between align-items-baseline gap-2 flex-wrap">
            <div>
              <h2 class="h5 mb-1" style="font-weight:900; letter-spacing:-.01em;">Livre de messages</h2>
            </div>
            <button class="btn btn-soft btn-sm px-3 no-print" id="refreshBtn" type="button">Actualiser</button>
          </div>

          <form id="guestForm" class="row g-2 mt-3 no-print">
            <div class="col-md-4">
              <input class="form-control" id="name" maxlength="60" placeholder="Votre nom" required>
            </div>
            <div class="col-md-8">
              <input class="form-control" id="title" maxlength="80" placeholder="Objet (optionnel)">
            </div>
            <div class="col-12">
              <textarea class="form-control" id="message" rows="4" maxlength="1200" placeholder="Votre message‚Ä¶" required></textarea>
            </div>
            <div class="col-12 d-flex gap-2 align-items-center">
              <button class="btn btn-dark px-4" type="submit" id="submitBtn">Publier</button>
              <span class="smallMuted ms-auto" id="charLeft"></span>
            </div>
          </form>

          <div class="mt-4 d-grid gap-2" id="guestList" aria-live="polite"></div>
        </section>
      </div>
    </div>
  </div>

  <div class="modal fade" id="imgModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content glass" style="border-radius:18px;">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="modalCap" style="font-weight:900;"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body pt-0">
          <img id="modalImg" alt="Photo agrandie" class="img-fluid rounded-4 border" style="border-color: rgba(15,23,42,.10) !important;">
          <div class="smallMuted mt-2" id="modalMeta"></div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="toast-container position-fixed bottom-0 end-0 p-3 no-print">
    <div id="toast" class="toast glass" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-body" id="toastBody"></div>
    </div>
  </div>
  <input type="text" id="company" autocomplete="off" tabindex="-1" 
    style="position:absolute;left:-9999px;opacity:0;height:0;width:0;">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <div class="cf-turnstile"
      data-sitekey="0x4AAAAAACgUTiEEzbQG7vkm"
      data-callback="onTurnstileSuccess">
  </div>

  <script>
    window.__TS_TOKEN = "";
    function onTurnstileSuccess(token) {
      window.__TS_TOKEN = token;
    }
  </script>

  <script type="module"> 
    function getTurnstileToken() {
      return window.__TS_TOKEN || "";
    }
    const API_BASE = "/.netlify/functions";
    async function apiJson(url, opts = {}) {
      const res = await fetch(url, {
        headers: { "Content-Type": "application/json" },
        ...opts
      });
      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); } catch {}
      if (!res.ok) throw new Error(text || `HTTP ${res.status}`);
      return json ?? {};
    }

    // üîß Mets ta sitekey Turnstile ici (publique)
    const TURNSTILE_SITEKEY = "0x4AAAAAACgUTiEEzbQG7vkm";

    let captchaModal;
    let tsWidgetId = null;
    let pendingAction = null;   // fonction async √† rejouer apr√®s captcha
    let lastToken = "";         // token Turnstile courant

    function ensureCaptchaModal() {
      if (!captchaModal) {
        captchaModal = new bootstrap.Modal(document.getElementById("captchaModal"));
      }
    }

    function renderTurnstileOnce() {
      if (!window.turnstile) {
        throw new Error("Turnstile non charg√© (CSP ou script bloqu√©).");
      }
      const mount = document.getElementById("tsMount");
      if (!mount) throw new Error("#tsMount introuvable");

      // Si d√©j√† rendu, on reset juste
      if (tsWidgetId !== null) {
        window.turnstile.reset(tsWidgetId);
        return;
      }

      tsWidgetId = window.turnstile.render(mount, {
        sitekey: TURNSTILE_SITEKEY,
        size: "normal",
        callback: (token) => {
          lastToken = token || "";
          // d√®s qu‚Äôon a un token, on ferme et on rejoue l‚Äôaction
          captchaModal?.hide();
          const fn = pendingAction;
          pendingAction = null;

          if (fn) fn().catch(err => showStatus(err.message || String(err), "error"));
        },
        "expired-callback": () => { lastToken = ""; },
        "error-callback": () => {
          lastToken = "";
          showStatus("Captcha indisponible. R√©essaie.", "error");
        }
      });
    }

    function requireCaptchaAndRun(actionFn) {
      // Si on a d√©j√† un token, on tente directement
      if (lastToken) return actionFn();

      pendingAction = actionFn;
      ensureCaptchaModal();

      // Quand le modal s‚Äôaffiche, on rend/refresh Turnstile
      const modalEl = document.getElementById("captchaModal");
      const onShown = () => {
        modalEl.removeEventListener("shown.bs.modal", onShown);
        try {
          renderTurnstileOnce();
        } catch (e) {
          showStatus(e.message || String(e), "error");
        }
      };
      modalEl.addEventListener("shown.bs.modal", onShown);

      captchaModal.show();
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    async function uploadAsset(file) {
      const base64 = await fileToBase64(file);
      const contentBase64 = base64.split(",")[1];
      return apiJson(`${API_BASE}/upload`, {
        method: "POST",
        body: JSON.stringify({ filename: file.name, mime: file.type, contentBase64 })
      });
    }

    async function postMessage({ name, title, message, turnstileToken }) {
      return apiJson(`${API_BASE}/message`, {
        method: "POST",
        body: JSON.stringify({ name, title, message, turnstileToken })
      });
    }

    async function listMessages() {
      return apiJson(`${API_BASE}/messages`);
    }

    async function getCandles() {
      const r = await apiJson(`${API_BASE}/candles`);
      return r.count || 0;
    }

    async function addCandle(turnstileToken) {
      await apiJson(`${API_BASE}/candle`, {
        method: "POST",
        body: JSON.stringify({ turnstileToken })
      });
    }

    const $ = (s) => document.querySelector(s);
    const escapeHtml = (s) => String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));

    function showStatus(msg, kind="info") {
      const el = document.getElementById("toast");
      document.getElementById("toastBody").innerHTML =
        `<strong>${kind === "error" ? "Erreur" : "Info"} :</strong> ${escapeHtml(msg)}`;
    
      const t = bootstrap.Toast.getOrCreateInstance(el, { delay: 3500 });
      t.show();
    }

    // Candles (GitHub reactions)
    async function refreshCandles() {
      try {
        const n = await getCandles();
        $("#candleCount").textContent = String(n);
        renderCandleViz(n);
      } catch (e) {
        $("#candleCount").textContent = "‚Äî";
        const mount = document.getElementById("candlesViz");
        if (mount) mount.innerHTML = "";
        showStatus(e.message || String(e), "error");
      }
    }

    $("#candleBtn").addEventListener("click", async () => {
      const btn = document.getElementById("candleBtn");
      const old = btn.textContent;

      btn.disabled = true;
      btn.textContent = "üïØÔ∏è ‚Ä¶";

      await requireCaptchaAndRun(async () => {
        try {
          await addCandle(lastToken);
          // Token consomm√© : on force un nouveau captcha la prochaine fois
          lastToken = "";
          if (tsWidgetId !== null) window.turnstile.reset(tsWidgetId);

          await refreshCandles();
          btn.textContent = "üïØÔ∏è Bougie allum√©e";
          setTimeout(() => (btn.textContent = old), 900);
        } catch (e) {
          // Si backend renvoie captcha failed -> on r√©ouvre le modal
          if (String(e.message || e).includes("Captcha failed")) {
            lastToken = "";
            if (tsWidgetId !== null) window.turnstile.reset(tsWidgetId);
            requireCaptchaAndRun(pendingAction || (async () => {}));
          } else {
            showStatus(e.message || String(e), "error");
          }
          btn.textContent = old;
        } finally {
          btn.disabled = false;
        }
      });
    });

    // Guestbook
    function renderMessages(items) {
      $("#msgCount").textContent = String(items.length);
      const list = $("#guestList");

      if (!items.length) {
        list.innerHTML = `<div class="smallMuted">Aucun message pour le moment.</div>`;
        return;
      }

      list.innerHTML = items.map(m => `
        <div class="msg">
          <div class="top">
            <div class="name">${escapeHtml(m.name || "Anonyme")}</div>
            <div class="date">${new Date(m.created_at).toLocaleString("fr-FR")}</div>
          </div>
          <div class="text">${escapeHtml(m.message || "")}</div>
        </div>
      `).join("");
    }

    function renderSkeleton() {
      const list = document.getElementById("guestList");
      list.innerHTML = `
        <div class="msg"><div class="placeholder-glow">
          <span class="placeholder col-4"></span>
          <span class="placeholder col-7"></span>
          <span class="placeholder col-9"></span>
        </div></div>
        <div class="msg"><div class="placeholder-glow">
          <span class="placeholder col-3"></span>
          <span class="placeholder col-8"></span>
          <span class="placeholder col-10"></span>
        </div></div>
      `;
    }
    
    async function refreshMessages() {
      try {
        renderSkeleton();
        const r = await listMessages();
        renderMessages(r.items || []);
      } catch (e) {
        showStatus(e.message || String(e), "error");
      }
    }

    const msgEl = $("#message");
    const leftEl = $("#charLeft");
    function updateCharLeft(){
      const max = msgEl.maxLength || 1200;
      leftEl.textContent = `${max - msgEl.value.length} caract√®res restants`;
    }
    msgEl.addEventListener("input", updateCharLeft);

    $("#guestForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value.trim();
      const title = document.getElementById("title").value.trim();
      const message = document.getElementById("message").value.trim();

      if (!name || !message) return;

      const btn = document.getElementById("submitBtn");
      btn.disabled = true;
      btn.textContent = "Publication‚Ä¶";

      await requireCaptchaAndRun(async () => {
        try {
          await postMessage({ name, title, message, turnstileToken: lastToken });

          // Token consomm√©
          lastToken = "";
          if (tsWidgetId !== null) window.turnstile.reset(tsWidgetId);

          document.getElementById("message").value = "";
          showStatus("Message publi√©.", "info");
          await refreshMessages();
        } catch (err) {
          if (String(err.message || err).includes("Captcha failed")) {
            lastToken = "";
            if (tsWidgetId !== null) window.turnstile.reset(tsWidgetId);
            // R√©ouvre le modal et retente
            requireCaptchaAndRun(pendingAction || (async () => {}));
          } else {
            showStatus(err.message || String(err), "error");
          }
        } finally {
          btn.disabled = false;
          btn.textContent = "Publier";
        }
      });
    });

    $("#refreshBtn").addEventListener("click", refreshMessages);

    // Gallery modal + upload
    let galleryPage = 1;
    const GALLERY_PER_PAGE = 12;
    let galleryHasMore = true;

    async function compressImage(file, { maxWidth = 1600, quality = 0.82 } = {}) {
      const bitmap = await createImageBitmap(file);
    
      const scale = Math.min(1, maxWidth / bitmap.width);
      const w = Math.round(bitmap.width * scale);
      const h = Math.round(bitmap.height * scale);
    
      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;
    
      const ctx = canvas.getContext("2d", { alpha: false });
      ctx.drawImage(bitmap, 0, 0, w, h);
    
      // JPEG (stable + l√©ger)
      const blob = await new Promise((resolve) =>
        canvas.toBlob(resolve, "image/jpeg", quality)
      );
    
      if (!blob) throw new Error("Compression failed");
      const newFile = new File([blob], file.name.replace(/\.\w+$/, "") + ".jpg", { type: "image/jpeg" });
      return newFile;
    }

    async function listAssets(page = 1, perPage = 12) {
      return apiJson(`${API_BASE}/assets?page=${page}&per_page=${perPage}`);
    }

    const modal = new bootstrap.Modal(document.getElementById("imgModal"));
    $("#gallery").addEventListener("click", (e) => {
      const img = e.target.closest("img");
      if (!img) return;
      $("#modalCap").textContent = img.dataset.cap || "Souvenir";
      $("#modalImg").src = img.dataset.full || img.src;
      $("#modalMeta").textContent = img.dataset.meta || "";
      modal.show();
    });

    $("#uploadInput").addEventListener("change", async (e) => {
      let file = e.target.files?.[0];
      if (!file) return;
      
      if (!file.type.startsWith("image/")) {
        showStatus("Type non support√© (image).", "error");
        return;
      }
      
      showStatus("Optimisation de l‚Äôimage‚Ä¶", "info");
      file = await compressImage(file, { maxWidth: 1600, quality: 0.82 });
      
      if (file.size > 1_500_000) {
        showStatus("Image encore trop lourde. R√©duis la qualit√© (0.75) ou la largeur (1400).", "error");
        return;
      }
      
      showStatus("Upload en cours‚Ä¶", "info");

      try {
        const r = await uploadAsset(file);
        if (!r?.url) throw new Error("Upload OK mais URL manquante.");

        await initGallery();

        showStatus("Photo ajout√©e √† la galerie et commit√©e dans GitHub.", "info");
      } catch (err) {
        showStatus(err.message || String(err), "error");
      } finally {
        e.target.value = "";
      }
    });

    function addGalleryItems(items) {
      const gallery = document.getElementById("gallery");

      for (const it of items) {
        const col = document.createElement("div");
        col.className = "col-sm-6";

        const fileName = it.path.split("/").pop() || "Souvenir";
        const cap = fileName
          .replace(/^\d+_/, "")
          .replace(/\.[^.]+$/, "")
          .replace(/[_-]+/g, " ");

        col.innerHTML = `
          <img loading="lazy"
              data-cap="${escapeHtml(cap)}"
              data-full="${escapeHtml(it.url)}"
              data-meta="${escapeHtml(it.path)}"
              src="${escapeHtml(it.url)}"
              alt="${escapeHtml(cap)}">
        `;
        gallery.appendChild(col);
      }
    }

    function setGalleryMeta({ page, per_page, total, has_more }) {
      const meta = document.getElementById("galleryMeta");
      const shown = Math.min(page * per_page, total);
      meta.textContent = `${shown}/${total} photos`;
      const btn = document.getElementById("loadMoreBtn");
      btn.style.display = has_more ? "" : "none";
    }

    async function loadGalleryPage(page) {
      const btn = document.getElementById("loadMoreBtn");
      btn.disabled = true;
      btn.textContent = "Chargement‚Ä¶";

      try {
        const r = await listAssets(page, GALLERY_PER_PAGE);
        addGalleryItems(r.items || []);
        galleryHasMore = !!r.has_more;
        setGalleryMeta(r);
      } catch (e) {
        showStatus(e.message || String(e), "error");
      } finally {
        btn.disabled = false;
        btn.textContent = "Charger plus";
      }
    }

    async function initGallery() {
      // reset
      $("#gallery").innerHTML = "";
      galleryPage = 1;
      galleryHasMore = true;
      await loadGalleryPage(galleryPage);
    }

    $("#loadMoreBtn").addEventListener("click", async () => {
      if (!galleryHasMore) return;
      galleryPage += 1;
      await loadGalleryPage(galleryPage);
    });

    // Share/Print
    $("#printBtn").addEventListener("click", () => window.print());
    $("#shareBtn").addEventListener("click", async () => {
      const data = { title: document.title, text: "Espace hommage", url: location.href };
      if (navigator.share) {
        try { await navigator.share(data); } catch {}
      } else {
        try { await navigator.clipboard.writeText(location.href); showStatus("Lien copi√©.", "info"); }
        catch { prompt("Copiez le lien :", location.href); }
      }
    });

   if ($("#company").value.trim()) {
     console.warn("Honeypot triggered");
   }

  function renderCandleViz(count){
    const mount = document.getElementById("candlesViz");
    if (!mount) return;

    const max = 18;                 // sobre
    const shown = Math.min(count, max);
    const more = count - shown;

    const strip = document.createElement("div");
    strip.className = "candleStrip";

    for (let i = 0; i < shown; i++){
      const c = document.createElement("div");
      c.className = "candle";
      // d√©synchronisation douce
      c.style.setProperty("--d", `${(i % 6) * 0.15}s`);
      strip.appendChild(c);
    }

    if (more > 0){
      const m = document.createElement("div");
      m.className = "candleMore";
      m.textContent = `+${more}`;
      strip.appendChild(m);
    }

    mount.innerHTML = "";
    mount.appendChild(strip);
  }

    // Init
    updateCharLeft();
    await refreshMessages();
    await refreshCandles();
    await initGallery();
  </script>
<!-- Modal Captcha -->
<div class="modal fade" id="captchaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass" style="border-radius:18px;">
      <div class="modal-header border-0">
        <h5 class="modal-title" style="font-weight:900;">Validation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body pt-0">
        <p class="smallMuted mb-3">
          Merci de confirmer avant de continuer.
        </p>

        <!-- Turnstile widget mount -->
        <div id="tsMount" class="d-flex justify-content-center"></div>

        <div class="smallMuted mt-3">
          Une fois valid√©, l‚Äôaction reprendra automatiquement.
        </div>
      </div>
    </div>
  </div>
</div>
</body>
</html>